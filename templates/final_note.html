{% extends "base.html" %}

{% block title %}Final Note - {{ class_name }} - {{ subject_name }} - EduNote{% endblock %}

{% block content %}
<div class="container">
    <div class="breadcrumb">
        <a href="{{ url_for('home') }}">
            <i class="fas fa-home"></i>
            Home
        </a>
        <i class="fas fa-chevron-right"></i>
        <a href="{{ url_for('subject_page', subject_name=subject_name) }}">{{ subject_name }}</a>
        <i class="fas fa-chevron-right"></i>
        <a href="{{ url_for('class_page', subject_name=subject_name, class_name=class_name) }}">{{ class_name }}</a>
        <i class="fas fa-chevron-right"></i>
        <span>Final Note Study Guide</span>
    </div>

    <div class="header">
        <h1><i class="fas fa-graduation-cap"></i> Final Note Study Guide</h1>
        <p>{{ subject_name }} • {{ class_name }} • Comprehensive Test Preparation</p>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="window.history.back()">
                <i class="fas fa-arrow-left"></i>
                Back to Class
            </button>
            <button class="btn btn-primary" onclick="printStudyGuide()">
                <i class="fas fa-print"></i>
                Print Study Guide
            </button>
        </div>
    </div>

    <!-- Index Selection -->
    <div class="index-selection">
        <h2>Select an Index to Study</h2>
        <div class="index-cards">
            {% if class_notes %}
                {% for index_key, index_notes in class_notes.items() %}
                    {% set index_title = index_key.replace('_', ' ').title() %}
                    <div class="index-card" onclick="toggleIndexContent('{{ index_key }}')">
                        <div class="index-card-header">
                            <h3><i class="fas fa-book"></i> {{ index_title }}</h3>
                            <span class="note-count">{{ index_notes|length }} note{{ 's' if index_notes|length != 1 else '' }}</span>
                            <i class="fas fa-chevron-down expand-icon" id="icon-{{ index_key }}"></i>
                        </div>
                        
                        <div class="index-content" id="content-{{ index_key }}" style="display: none;">
                            {% for note in index_notes %}
                                <div class="note-study-card">
                                    <div class="note-header">
                                        <h4>{{ note.original_name }}</h4>
                                        <span class="note-date">{{ note.upload_date[:10] }}</span>
                                    </div>
                                    
                                    {% if note.ai_analysis.important_points %}
                                    <div class="important-points-section">
                                        <h5><i class="fas fa-star"></i> Key Points</h5>
                                        <div class="points-grid">
                                            {% for point in note.ai_analysis.important_points %}
                                            <div class="point-card">
                                                <div class="point-header">
                                                    <span class="point-number">{{ loop.index }}</span>
                                                    <span class="point-type">{{ point.type }}</span>
                                                </div>
                                                <div class="point-text">{{ point.text }}</div>
                                                <div class="point-explanation">{{ point.explanation }}</div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if note.ai_analysis.test_questions %}
                                    <div class="sample-problems-section">
                                        <h5><i class="fas fa-question-circle"></i> Sample Problems</h5>
                                        <div class="problems-list">
                                            {% for question in note.ai_analysis.test_questions[:3] %}
                                            <div class="problem-item">
                                                <span class="problem-number">{{ loop.index }}.</span>
                                                <span class="problem-text">{{ question }}</span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if note.ai_analysis.important_equations %}
                                    <div class="equations-section">
                                        <h5><i class="fas fa-calculator"></i> Important Equations</h5>
                                        <div class="equations-list">
                                            {% for equation in note.ai_analysis.important_equations %}
                                            <div class="equation-item">
                                                <code class="equation-code">{{ equation }}</code>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-book"></i>
                    <h3>No notes available</h3>
                    <p>Upload some notes to create your study guide!</p>
                    <button class="btn btn-primary" onclick="window.history.back()">
                        <i class="fas fa-arrow-left"></i>
                        Go Back to Upload Notes
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function printStudyGuide() {
    window.print();
}

function toggleIndexContent(indexKey) {
    const content = document.getElementById(`content-${indexKey}`);
    const icon = document.getElementById(`icon-${indexKey}`);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
    } else {
        content.style.display = 'none';
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    }
}

// Add print styles
document.addEventListener('DOMContentLoaded', function() {
    const printStyles = `
        @media print {
            .header-actions, .breadcrumb { display: none !important; }
            .study-guide-content { font-size: 12pt; }
            .point-card, .note-summary-card { break-inside: avoid; }
        }
    `;
    
    const styleSheet = document.createElement("style");
    styleSheet.type = "text/css";
    styleSheet.innerText = printStyles;
    document.head.appendChild(styleSheet);
});
</script>

<style>
.study-guide-content {
    margin-top: 30px;
}

.index-section {
    background: white;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.index-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e2e8f0;
}

.index-header h2 {
    color: #2d3748;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.note-count {
    background: #667eea;
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.note-summary-card {
    background: #f8fafc;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 4px solid #667eea;
}

.note-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.note-header h4 {
    color: #2d3748;
    margin: 0;
}

.note-date {
    color: #718096;
    font-size: 0.9rem;
}

.important-points-section, .sample-problems-section, .equations-section {
    margin-bottom: 20px;
}

.important-points-section h5, .sample-problems-section h5, .equations-section h5 {
    color: #4a5568;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.points-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
}

.point-card {
    background: white;
    border: 2px solid #fbbf24;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(251, 191, 36, 0.2);
}

.point-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.point-number {
    background: #667eea;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.8rem;
}

.point-type {
    background: #fbbf24;
    color: #2d3748;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
}

.point-text {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.point-explanation {
    color: #4a5568;
    font-size: 0.85rem;
    line-height: 1.4;
}

.problems-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.problem-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    background: white;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #48bb78;
}

.problem-number {
    font-weight: 600;
    color: #48bb78;
    flex-shrink: 0;
}

.problem-text {
    color: #2d3748;
    line-height: 1.5;
}

.equations-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.equation-item {
    background: white;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #ed8936;
}

.equation-code {
    background: #f7fafc;
    padding: 10px;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    font-size: 1rem;
    color: #2d3748;
    display: block;
    overflow-x: auto;
}

@media (max-width: 768px) {
    .points-grid {
        grid-template-columns: 1fr;
    }
    
    .note-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
    
    .index-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
}
</style>
{% endblock %}
